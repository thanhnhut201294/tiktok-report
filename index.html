<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Report Video</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=Fredoka:wght@600;700&display=swap" rel="stylesheet">

  <style>
    /* === THI·∫æT K·∫æ NEUBRUTALISM / CARTOON === */
    :root {
      --primary: #ff0050;      /* H·ªìng TikTok */
      --secondary: #00f2ea;    /* Xanh TikTok */
      --yellow: #ffd900;       /* M√†u nh·∫•n */
      --bg-color: #f0f4f8;     /* N·ªÅn trang */
      --border-color: #000;    /* Vi·ªÅn ƒëen */
      --white: #fff;
    }

    * { box-sizing: border-box; }

    body { 
      /* S·ª≠ d·ª•ng Be Vietnam Pro cho to√†n b·ªô th√¢n trang */
      font-family: 'Be Vietnam Pro', sans-serif; 
      padding: 20px; 
      background: var(--bg-color); 
      color: var(--border-color);
      background-image: radial-gradient(#dbe3ea 15%, transparent 16%);
      background-size: 20px 20px;
    }

    /* N√∫t Quay L·∫°i Trang Ch·ªß */
    .home-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      text-decoration: none;
      background: var(--white);
      color: var(--border-color);
      padding: 10px 20px;
      border: 3px solid var(--border-color);
      box-shadow: 4px 4px 0px var(--border-color);
      border-radius: 50px;
      font-weight: 700;
      transition: all 0.2s;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: 'Be Vietnam Pro', sans-serif; /* ƒê·∫£m b·∫£o n√∫t d√πng font m·ªõi */
    }
    .home-btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0px var(--border-color);
      background: var(--yellow);
    }
    .home-btn:active {
      transform: translate(2px, 2px);
      box-shadow: 0px 0px 0px var(--border-color);
    }

    main { 
      max-width: 1200px; 
      margin: 40px auto 0; 
      background: var(--white); 
      padding: 30px; 
      border: 3px solid var(--border-color);
      box-shadow: 10px 10px 0px var(--border-color);
      border-radius: 20px;
      position: relative;
    }

    /* RI√äNG TI√äU ƒê·ªÄ GI·ªÆ FONT C≈® (FREDOKA) */
    h1 { 
      font-family: 'Fredoka', sans-serif; /* Font c≈© */
      margin-top: 0; 
      text-align: center; 
      color: var(--primary); 
      font-size: 3rem;
      text-shadow: 3px 3px 0px var(--border-color);
      margin-bottom: 30px;
      letter-spacing: 1px;
    }

    /* === DASHBOARD TH·ªêNG K√ä === */
    #stats-board { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 20px; 
      margin-bottom: 30px; 
    }
    
    .stat-card { 
      background: #fff; 
      padding: 15px; 
      text-align: center; 
      border: 3px solid var(--border-color);
      box-shadow: 6px 6px 0px var(--border-color);
      border-radius: 15px;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); }
    
    .stat-card:nth-child(1) { background: #e0f7fa; }
    .stat-card:nth-child(2) { background: #fce4ec; }
    .stat-card:nth-child(3) { background: #fff9c4; }
    .stat-card:nth-child(4) { background: #f3e5f5; }
    .stat-card:nth-child(5) { background: #e8f5e9; }

    .stat-title { 
      font-size: 13px; 
      font-weight: 700; 
      text-transform: uppercase; 
      margin-bottom: 5px; 
      font-family: 'Be Vietnam Pro', sans-serif;
    }
    .stat-value { 
      font-size: 24px; 
      font-weight: 800; 
      color: var(--border-color);
      margin-bottom: 8px;
      font-family: 'Be Vietnam Pro', sans-serif;
    }
    .stat-avg { 
      font-size: 12px; 
      font-weight: 600; 
      background: var(--border-color); 
      color: var(--white); 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 8px;
      font-family: 'Be Vietnam Pro', sans-serif;
    }

    /* === INPUT AREA === */
    .input-area { margin-bottom: 25px; }
    label { font-weight: 700; margin-bottom: 10px; display: block; font-size: 16px;}
    
    textarea { 
      width: 100%; 
      height: 120px; 
      padding: 15px; 
      font-size: 15px; 
      font-family: 'Be Vietnam Pro', sans-serif; /* Font m·ªõi */
      resize: vertical;
      border: 3px solid var(--border-color);
      box-shadow: 5px 5px 0px var(--border-color);
      border-radius: 15px;
      outline: none;
      transition: 0.2s;
    }
    textarea:focus {
      background: #fdffed;
      transform: translate(-2px, -2px);
      box-shadow: 7px 7px 0px var(--primary);
    }

    /* === TOOLBAR BUTTONS === */
    .toolbar { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;}
    
    button { 
      padding: 0 25px; 
      height: 50px; 
      cursor: pointer; 
      font-weight: 700; 
      font-size: 15px; 
      font-family: 'Be Vietnam Pro', sans-serif; /* Font m·ªõi */
      white-space: nowrap; 
      display: flex; 
      align-items: center; 
      gap: 8px;
      border: 3px solid var(--border-color);
      box-shadow: 5px 5px 0px var(--border-color);
      border-radius: 12px;
      transition: all 0.1s;
    }

    button:active {
      transform: translate(3px, 3px);
      box-shadow: 2px 2px 0px var(--border-color);
    }
    button:disabled {
      background: #ccc !important;
      color: #777 !important;
      box-shadow: none !important;
      transform: translate(3px, 3px);
      cursor: not-allowed;
    }
    
    #fetchBtn { background: var(--primary); color: #fff; }
    #fetchBtn:hover { background: #ff3370; }
    
    .btn-secondary { background: var(--white); color: var(--border-color); }
    .btn-secondary:hover { background: #f0f0f0; }
    
    .btn-excel { background: var(--secondary); color: var(--border-color); }
    .btn-excel:hover { background: #33fff8; }

    /* === LOGGER === */
    #status { 
      margin-bottom: 25px; 
      padding: 15px; 
      border-radius: 12px; 
      font-weight: 600;
      border: 3px solid var(--border-color);
      background: #fff;
    }
    .log-process { background: #e3f2fd !important; color: #0d47a1; }
    .log-done { background: #e8f5e9 !important; color: #1b5e20; }

    /* === TABLE === */
    .table-container { 
      overflow-x: auto; 
      border-radius: 15px; 
      border: 3px solid var(--border-color);
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 1000px; 
      font-family: 'Be Vietnam Pro', sans-serif; /* Font m·ªõi */
    }
    
    th { 
      background: var(--secondary); 
      color: var(--border-color); 
      font-weight: 700; 
      padding: 15px; 
      text-align: left; 
      border-bottom: 3px solid var(--border-color);
      border-right: 2px solid var(--border-color);
      text-transform: uppercase;
      font-size: 14px;
    }
    
    td { 
      border-bottom: 2px solid var(--border-color); 
      border-right: 2px solid var(--border-color);
      padding: 12px 15px; 
      vertical-align: middle; 
      font-weight: 500;
    }
    
    tr:last-child td { border-bottom: none; }
    th:last-child, td:last-child { border-right: none; }
    
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #fffde7; }
    
    .col-thumb img { 
      width: 45px; 
      height: 45px; 
      object-fit: cover; 
      border-radius: 8px; 
      border: 2px solid var(--border-color); 
      background: #eee; 
    }
    
    .col-caption { 
      max-width: 250px; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis;
    }
    
    .status-ok { color: #00c853; font-weight: 800; }
    .status-err { color: #d50000; font-weight: 800; }
    
    .col-link a { 
      color: var(--primary); 
      text-decoration: none; 
      font-weight: 700;
      border-bottom: 2px solid transparent;
    }
    .col-link a:hover { border-bottom: 2px solid var(--primary); }

    .stat-num { font-family: 'Be Vietnam Pro', sans-serif; }
    .loading-row { opacity: 0.6; background: #eee !important; }

    @media (max-width: 768px) {
      .toolbar { flex-direction: column; }
      button { width: 100%; justify-content: center; }
      .home-btn span { display: none; }
    }
  </style>
</head>
<body>

  <a href="https://thanhnhut201294.github.io/tool/" class="home-btn">
    üè° <span>Quay l·∫°i trang ch·ªß</span>
  </a>

  <main>
    <h1>üé¨ TikTok Report Video</h1>
    
    <div id="stats-board">
        <div class="stat-card">
            <div class="stat-title">L∆∞·ª£t Xem üëÅÔ∏è</div>
            <div class="stat-value" id="total-view">0</div>
            <div class="stat-avg" id="avg-view">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Tim ‚ù§Ô∏è</div>
            <div class="stat-value" id="total-like">0</div>
            <div class="stat-avg" id="avg-like">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">B√¨nh Lu·∫≠n üí¨</div>
            <div class="stat-value" id="total-cmt">0</div>
            <div class="stat-avg" id="avg-cmt">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">L∆∞u üíæ</div>
            <div class="stat-value" id="total-save">0</div>
            <div class="stat-avg" id="avg-save">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Chia S·∫ª üîó</div>
            <div class="stat-value" id="total-share">0</div>
            <div class="stat-avg" id="avg-share">TB: 0</div>
        </div>
    </div>

    <div class="input-area">
      <label>üìù D√°n Link Video (M·ªói d√≤ng 1 link nha):</label>
      <textarea id="linkInput" placeholder="https://www.tiktok.com/@user/video/...\nhttps://vt.tiktok.com/..."></textarea>
    </div>

    <div class="toolbar">
      <button id="fetchBtn">üöÄ Qu√©t Data Ngay</button>
      <button class="btn-secondary" id="clearBtn">üßπ Xo√° S·∫°ch</button>
      <button class="btn-secondary" id="sampleBtn">üìã D√°n Link M·∫´u</button>
      <button class="btn-excel" id="exportBtn" disabled>üì• Xu·∫•t Excel</button>
    </div>

    <div id="status">üëã S·∫µn s√†ng l√†m vi·ªác!</div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width: 50px;">#</th>
            <th>·∫¢nh</th>
            <th>K√™nh</th>
            <th>Caption</th>
            <th>View</th>
            <th>Like</th>
            <th>Cmt</th>
            <th>Save</th>
            <th>Share</th>
            <th>Link</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // === C·∫§U H√åNH ===
    const PROXY_LIST = [
        { url: 'https://api.codetabs.com/v1/proxy?quest=', type: 'direct' },
        { url: 'https://corsproxy.io/?', type: 'direct' },
        { url: 'https://api.allorigins.win/get?url=', type: 'wrapped' }
    ];

    let processedData = []; 
    let isProcessing = false;

    // === H√ÄM TI·ªÜN √çCH ===
    const $ = (id) => document.getElementById(id);
    const log = (msg, type = '') => {
      const el = $('status');
      el.textContent = msg;
      el.className = type;
    };
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmt = (n) => n.toLocaleString('vi-VN'); 

    // C·∫≠p nh·∫≠t Dashboard th·ªëng k√™
    function updateDashboard() {
        let tView = 0, tLike = 0, tCmt = 0, tSave = 0, tShare = 0;
        
        const validItems = processedData.filter(i => i.status === 'OK');
        const count = validItems.length;

        validItems.forEach(i => {
            tView += i.view;
            tLike += i.like;
            tCmt += i.comment;
            tSave += i.save;
            tShare += i.share;
        });

        const calcAvg = (total) => count > 0 ? fmt(Math.round(total / count)) : '0';

        $('total-view').innerText = fmt(tView);
        $('avg-view').innerText = `TB: ${calcAvg(tView)}`;

        $('total-like').innerText = fmt(tLike);
        $('avg-like').innerText = `TB: ${calcAvg(tLike)}`;

        $('total-cmt').innerText = fmt(tCmt);
        $('avg-cmt').innerText = `TB: ${calcAvg(tCmt)}`;

        $('total-save').innerText = fmt(tSave);
        $('avg-save').innerText = `TB: ${calcAvg(tSave)}`;

        $('total-share').innerText = fmt(tShare);
        $('avg-share').innerText = `TB: ${calcAvg(tShare)}`;
    }

    // === API FETCH ===
    async function smartFetch(targetUrl) {
        for (const proxy of PROXY_LIST) {
            try {
                const finalUrl = proxy.url + encodeURIComponent(targetUrl);
                const res = await fetch(finalUrl);
                if (!res.ok) throw new Error('Network Error');
                
                let data;
                if (proxy.type === 'wrapped') {
                    const temp = await res.json();
                    if(!temp.contents) throw new Error("No contents");
                    data = JSON.parse(temp.contents);
                } else {
                    data = await res.json();
                }
                return data; 
            } catch (e) { continue; }
        }
        throw new Error("T·∫•t c·∫£ Proxy ƒë·ªÅu th·∫•t b·∫°i.");
    }

    // === LOGIC CH√çNH ===
    $('fetchBtn').addEventListener('click', async () => {
        if (isProcessing) return;

        const rawText = $('linkInput').value.trim();
        if (!rawText) return alert("Vui l√≤ng nh·∫≠p danh s√°ch link!");

        const links = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        if (links.length === 0) return;

        isProcessing = true;
        processedData = []; 
        $('tableBody').innerHTML = ''; 
        updateDashboard(); 
        
        $('fetchBtn').disabled = true;
        $('exportBtn').disabled = true;

        log(`üöÄ ƒêang kh·ªüi ƒë·ªông... Chu·∫©n b·ªã qu√©t ${links.length} link!`, 'log-process');

        for (let i = 0; i < links.length; i++) {
            const link = links[i];
            const rowId = i + 1;
            
            createRowUI(rowId, link, null, true);
            log(`‚è≥ ƒêang x·ª≠ l√Ω d√≤ng ${rowId}/${links.length}...`, 'log-process');

            try {
                const apiUrl = `https://www.tikwm.com/api/?url=${link}&hd=1`;
                const data = await smartFetch(apiUrl);

                if (data.data) {
                    const info = data.data;
                    const resultObj = {
                        id: rowId,
                        link: link,
                        author: info.author.unique_id,
                        avatar: info.cover,
                        caption: info.title || '',
                        view: info.play_count || 0,
                        like: info.digg_count || 0,
                        comment: info.comment_count || 0,
                        save: info.collect_count || 0,
                        share: info.share_count || 0,
                        status: 'OK'
                    };
                    processedData.push(resultObj);
                    updateRowUI(rowId, resultObj);
                } else {
                    throw new Error("Kh√¥ng t√¨m th·∫•y video");
                }
            } catch (err) {
                const errorObj = { id: rowId, link: link, status: 'ERROR' };
                processedData.push(errorObj);
                updateRowUI(rowId, errorObj, true);
            }
            
            updateDashboard();

            if (i < links.length - 1) await sleep(800); 
        }

        isProcessing = false;
        $('fetchBtn').disabled = false;
        $('exportBtn').disabled = false;
        log(`üéâ Xong phim! ƒê√£ qu√©t xong ${links.length} link.`, 'log-done');
    });

    // === GIAO DI·ªÜN B·∫¢NG ===
    function createRowUI(id, link, data, isLoading = false) {
        const tbody = $('tableBody');
        const tr = document.createElement('tr');
        tr.id = `row-${id}`;
        tr.className = isLoading ? 'loading-row' : '';
        
        tr.innerHTML = `
            <td>${id}</td>
            <td class="col-thumb"><div style="width:40px;height:40px;background:#eee;border-radius:4px;"></div></td>
            <td>...</td>
            <td>...</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td class="col-link"><a href="${link}" target="_blank">Xem</a></td>
            <td class="col-status">...</td>
        `;
        tbody.appendChild(tr);
    }

    function updateRowUI(id, data, isError = false) {
        const tr = $(`row-${id}`);
        if (!tr) return;
        tr.classList.remove('loading-row');

        if (isError) {
            tr.innerHTML = `
                <td>${id}</td>
                <td colspan="8" style="color: #d50000; text-align:center; font-weight:bold;">L·ªói: Check l·∫°i link nha!</td>
                <td class="col-link"><a href="${data.link}" target="_blank">Link</a></td>
                <td class="col-status status-err">FAIL</td>
            `;
        } else {
            tr.innerHTML = `
                <td>${id}</td>
                <td class="col-thumb"><img src="${data.avatar}" loading="lazy"></td>
                <td>${data.author}</td>
                <td class="col-caption" title="${data.caption.replace(/"/g, '&quot;')}">${data.caption}</td>
                <td class="stat-num">${fmt(data.view)}</td>
                <td class="stat-num">${fmt(data.like)}</td>
                <td class="stat-num">${fmt(data.comment)}</td>
                <td class="stat-num">${fmt(data.save)}</td>
                <td class="stat-num">${fmt(data.share)}</td>
                <td class="col-link"><a href="${data.link}" target="_blank">Xem</a></td>
                <td class="col-status status-ok">OK</td>
            `;
        }
    }

    // === CH·ª®C NƒÇNG PH·ª§ ===
    $('clearBtn').addEventListener('click', () => {
        $('linkInput').value = '';
        $('tableBody').innerHTML = '';
        processedData = [];
        updateDashboard();
        $('exportBtn').disabled = true;
        log("ƒê√£ d·ªçn d·∫πp s·∫°ch s·∫Ω! üßπ");
    });

    $('sampleBtn').addEventListener('click', () => {
        const sampleLinks = [
            "https://www.tiktok.com/@letuankhang2002/video/7578120269450071304",
            "https://www.tiktok.com/@letuankhang2002/video/7572146167778397447",
            "https://vt.tiktok.com/ZSfGHPdRK/"
        ];
        $('linkInput').value = sampleLinks.join('\n');
    });

    $('exportBtn').addEventListener('click', () => {
        if (!processedData.length) return;
        const headers = ['STT', 'Kenh', 'Caption', 'View', 'Like', 'Comment', 'Save', 'Share', 'Link Goc', 'Trang Thai'];
        const rows = processedData.map(item => {
            if (item.status === 'ERROR') return [item.id, '', 'ERROR', 0, 0, 0, 0, 0, item.link, 'ERROR'];
            const safeCaption = `"${(item.caption || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`;
            return [
                item.id, item.author, safeCaption, 
                item.view, item.like, item.comment, item.save, item.share, 
                item.link, 'OK'
            ];
        });
        const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `TikTok_Report_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
  </script>
</body>
</html>
