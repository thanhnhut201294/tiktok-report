<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Multi-Link Analyzer Pro</title>
  <style>
    /* === C·∫§U H√åNH M√ÄU S·∫ÆC CH·ª¶ ƒê·∫†O (#014a1d) === */
    :root {
      --primary-color: #014a1d;       /* M√†u xanh ch·ªß ƒë·∫°o */
      --primary-hover: #025e25;       /* M√†u xanh khi hover */
      --light-bg: #e6f0ea;            /* N·ªÅn nh·∫°t cho c√°c box */
      --text-color: #333;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding:20px; background:#f4f5f7; color:var(--text-color); }
    main { max-width:1200px; margin: 0 auto; background: #fff; padding: 25px; border-radius:12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    
    h1 { margin-top:0; text-align: center; color: var(--primary-color); display: flex; align-items: center; justify-content: center; gap: 10px;}
    
    /* V√πng nh·∫≠p li·ªáu */
    .input-area { margin-bottom: 20px; }
    label { font-weight: 600; margin-bottom: 8px; display: block; font-size: 14px; color: #555;}
    textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box; font-family: monospace;}
    textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(1, 74, 29, 0.1); }

    /* Thanh c√¥ng c·ª• */
    .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;}
    button { padding: 0 20px; border: none; border-radius: 6px; cursor:pointer; font-weight: 600; font-size: 14px; height: 40px; transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px;}
    
    #fetchBtn { background:var(--primary-color); color:#fff; }
    #fetchBtn:hover { background:var(--primary-hover); }
    #fetchBtn:disabled { background:#ccc; cursor: not-allowed; opacity: 0.7;}
    
    .btn-secondary { background: #f1f1f2; color: #161823; border: 1px solid #e1e1e1; }
    .btn-secondary:hover { background: #eaeaeb; }
    
    .btn-excel { background:#00c0b6; color:#fff; }
    .btn-excel:hover { background:#00a098; }
    .btn-excel:disabled { background:#ccc; cursor: not-allowed;}

    /* === DASHBOARD TH·ªêNG K√ä (M·ªõi) === */
    #stats-board { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 15px; 
      margin-bottom: 25px; 
      padding: 15px;
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #eee;
    }
    
    .stat-card { 
      background: #fff; 
      padding: 15px; 
      border-radius: 8px; 
      border: 1px solid #eee; 
      text-align: center; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .stat-title { font-size: 12px; text-transform: uppercase; color: #666; letter-spacing: 0.5px; margin-bottom: 8px; }
    .stat-value { font-size: 22px; font-weight: 800; color: #333; margin-bottom: 5px; }
    
    /* Pill hi·ªÉn th·ªã trung b√¨nh */
    .stat-avg { 
      font-size: 12px; 
      color: var(--primary-color); 
      font-weight: 600; 
      background: rgba(1, 74, 29, 0.1); /* M√†u xanh nh·∫°t */
      display: inline-block; 
      padding: 3px 10px; 
      border-radius: 12px;
    }

    /* Logger */
    #status { margin-bottom:15px; padding: 10px; border-radius: 6px; background: #f8f9fa; font-family: monospace; font-size: 13px; color: #333; border-left: 4px solid #ddd;}
    .log-process { border-left-color: #007bff !important; background: #ebf5ff !important; color: #004085 !important; }
    .log-done { border-left-color: var(--primary-color) !important; background: var(--light-bg) !important; color: var(--primary-color) !important; }

    /* Table */
    .table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
    table { width:100%; border-collapse:collapse; min-width: 1000px; font-size: 14px; }
    th { background:#f8f9fa; color: #161823; font-weight: 700; padding: 12px; text-align: left; border-bottom: 2px solid #eee; white-space: nowrap;}
    td { border-bottom:1px solid #f1f1f2; padding: 10px 12px; vertical-align: middle; color: #161823;}
    tr:hover { background-color: #fcfcfc; }
    
    .col-thumb img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; background: #eee; border: 1px solid #ddd;}
    .col-caption { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px;}
    .col-status { font-weight: bold; font-size: 12px; }
    .status-ok { color: var(--primary-color); }
    .status-err { color: #dc3545; }
    .col-link a { color: var(--primary-color); text-decoration: none; font-size: 13px;}
    .col-link a:hover { text-decoration: underline; }

    .stat-num { font-family: monospace; font-size: 14px; }
    .loading-row { opacity: 0.5; background: #fffcfc; }
  </style>
</head>
<body>
  <main>
    <h1>TikTok Analytics Pro</h1>
    
    <div id="stats-board">
        <div class="stat-card">
            <div class="stat-title">T·ªïng L∆∞·ª£t Xem</div>
            <div class="stat-value" id="total-view">0</div>
            <div class="stat-avg" id="avg-view">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">T·ªïng Tim</div>
            <div class="stat-value" id="total-like">0</div>
            <div class="stat-avg" id="avg-like">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">T·ªïng Comment</div>
            <div class="stat-value" id="total-cmt">0</div>
            <div class="stat-avg" id="avg-cmt">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">T·ªïng L∆∞u</div>
            <div class="stat-value" id="total-save">0</div>
            <div class="stat-avg" id="avg-save">TB: 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">T·ªïng Chia S·∫ª</div>
            <div class="stat-value" id="total-share">0</div>
            <div class="stat-avg" id="avg-share">TB: 0</div>
        </div>
    </div>

    <div class="input-area">
      <label>Danh s√°ch link TikTok (M·ªói link 1 d√≤ng):</label>
      <textarea id="linkInput" placeholder="D√°n link v√†o ƒë√¢y..."></textarea>
    </div>

    <div class="toolbar">
      <button id="fetchBtn">üîç L·∫•y th√¥ng tin</button>
      <button class="btn-secondary" id="clearBtn">üßπ Xo√° b·∫£ng</button>
      <button class="btn-secondary" id="sampleBtn">üìã D√°n m·∫´u</button>
      <button class="btn-excel" id="exportBtn" disabled>üì• T·∫£i Excel</button>
    </div>

    <div id="status">S·∫µn s√†ng.</div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width: 50px;">STT</th>
            <th>·∫¢nh</th>
            <th>K√™nh</th>
            <th>Caption</th>
            <th>View</th>
            <th>Like</th>
            <th>Comment</th>
            <th>Save</th>
            <th>Share</th>
            <th>Link g·ªëc</th>
            <th>Tr·∫°ng th√°i</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // === C·∫§U H√åNH ===
    const PROXY_LIST = [
        { url: 'https://api.codetabs.com/v1/proxy?quest=', type: 'direct' },
        { url: 'https://corsproxy.io/?', type: 'direct' },
        { url: 'https://api.allorigins.win/get?url=', type: 'wrapped' }
    ];

    let processedData = []; 
    let isProcessing = false;

    // === H√ÄM TI·ªÜN √çCH ===
    const $ = (id) => document.getElementById(id);
    const log = (msg, type = '') => {
      const el = $('status');
      el.textContent = msg;
      el.className = type;
    };
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmt = (n) => n.toLocaleString('vi-VN'); // Format s·ªë 1.000.000

    // C·∫≠p nh·∫≠t Dashboard th·ªëng k√™
    function updateDashboard() {
        let tView = 0, tLike = 0, tCmt = 0, tSave = 0, tShare = 0;
        
        // Ch·ªâ t√≠nh c√°c video l·∫•y th√†nh c√¥ng (OK)
        const validItems = processedData.filter(i => i.status === 'OK');
        const count = validItems.length;

        validItems.forEach(i => {
            tView += i.view;
            tLike += i.like;
            tCmt += i.comment;
            tSave += i.save;
            tShare += i.share;
        });

        // H√†m t√≠nh trung b√¨nh
        const calcAvg = (total) => count > 0 ? fmt(Math.round(total / count)) : '0';

        // Render ra HTML
        $('total-view').innerText = fmt(tView);
        $('avg-view').innerText = `TB: ${calcAvg(tView)}`;

        $('total-like').innerText = fmt(tLike);
        $('avg-like').innerText = `TB: ${calcAvg(tLike)}`;

        $('total-cmt').innerText = fmt(tCmt);
        $('avg-cmt').innerText = `TB: ${calcAvg(tCmt)}`;

        $('total-save').innerText = fmt(tSave);
        $('avg-save').innerText = `TB: ${calcAvg(tSave)}`;

        $('total-share').innerText = fmt(tShare);
        $('avg-share').innerText = `TB: ${calcAvg(tShare)}`;
    }

    // === API FETCH ===
    async function smartFetch(targetUrl) {
        for (const proxy of PROXY_LIST) {
            try {
                const finalUrl = proxy.url + encodeURIComponent(targetUrl);
                const res = await fetch(finalUrl);
                if (!res.ok) throw new Error('Network Error');
                
                let data;
                if (proxy.type === 'wrapped') {
                    const temp = await res.json();
                    if(!temp.contents) throw new Error("No contents");
                    data = JSON.parse(temp.contents);
                } else {
                    data = await res.json();
                }
                return data; 
            } catch (e) { continue; }
        }
        throw new Error("T·∫•t c·∫£ Proxy ƒë·ªÅu th·∫•t b·∫°i.");
    }

    // === LOGIC CH√çNH ===
    $('fetchBtn').addEventListener('click', async () => {
        if (isProcessing) return;

        const rawText = $('linkInput').value.trim();
        if (!rawText) return alert("Vui l√≤ng nh·∫≠p danh s√°ch link!");

        const links = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        if (links.length === 0) return;

        isProcessing = true;
        processedData = []; 
        $('tableBody').innerHTML = ''; 
        updateDashboard(); // Reset th·ªëng k√™ v·ªÅ 0
        
        $('fetchBtn').disabled = true;
        $('exportBtn').disabled = true;

        log(`üöÄ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω ${links.length} link...`, 'log-process');

        for (let i = 0; i < links.length; i++) {
            const link = links[i];
            const rowId = i + 1;
            
            createRowUI(rowId, link, null, true);
            log(`‚è≥ ƒêang x·ª≠ l√Ω ${rowId}/${links.length}...`, 'log-process');

            try {
                const apiUrl = `https://www.tikwm.com/api/?url=${link}&hd=1`;
                const data = await smartFetch(apiUrl);

                if (data.data) {
                    const info = data.data;
                    const resultObj = {
                        id: rowId,
                        link: link,
                        author: info.author.unique_id,
                        avatar: info.cover,
                        caption: info.title || '',
                        view: info.play_count || 0,
                        like: info.digg_count || 0,
                        comment: info.comment_count || 0,
                        save: info.collect_count || 0,
                        share: info.share_count || 0,
                        status: 'OK'
                    };
                    processedData.push(resultObj);
                    updateRowUI(rowId, resultObj);
                } else {
                    throw new Error("Kh√¥ng t√¨m th·∫•y video");
                }
            } catch (err) {
                const errorObj = { id: rowId, link: link, status: 'ERROR' };
                processedData.push(errorObj);
                updateRowUI(rowId, errorObj, true);
            }
            
            // C·∫≠p nh·∫≠t th·ªëng k√™ ngay l·∫≠p t·ª©c sau m·ªói d√≤ng
            updateDashboard();

            if (i < links.length - 1) await sleep(800); 
        }

        isProcessing = false;
        $('fetchBtn').disabled = false;
        $('exportBtn').disabled = false;
        log(`‚úÖ Ho√†n t·∫•t! ƒê√£ x·ª≠ l√Ω ${links.length} link.`, 'log-done');
    });

    // === GIAO DI·ªÜN B·∫¢NG ===
    function createRowUI(id, link, data, isLoading = false) {
        const tbody = $('tableBody');
        const tr = document.createElement('tr');
        tr.id = `row-${id}`;
        tr.className = isLoading ? 'loading-row' : '';
        
        tr.innerHTML = `
            <td>${id}</td>
            <td class="col-thumb"><div style="width:40px;height:40px;background:#eee;border-radius:4px;"></div></td>
            <td>...</td>
            <td>...</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td class="col-link"><a href="${link}" target="_blank">Xem</a></td>
            <td class="col-status" style="color:#999">Running...</td>
        `;
        tbody.appendChild(tr);
    }

    function updateRowUI(id, data, isError = false) {
        const tr = $(`row-${id}`);
        if (!tr) return;
        tr.classList.remove('loading-row');

        if (isError) {
            tr.innerHTML = `
                <td>${id}</td>
                <td colspan="8" style="color: #dc3545; text-align:center;">L·ªói: Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin</td>
                <td class="col-link"><a href="${data.link}" target="_blank">Link</a></td>
                <td class="col-status status-err">ERROR</td>
            `;
        } else {
            tr.innerHTML = `
                <td>${id}</td>
                <td class="col-thumb"><img src="${data.avatar}" loading="lazy"></td>
                <td>${data.author}</td>
                <td class="col-caption" title="${data.caption.replace(/"/g, '&quot;')}">${data.caption}</td>
                <td class="stat-num">${fmt(data.view)}</td>
                <td class="stat-num">${fmt(data.like)}</td>
                <td class="stat-num">${fmt(data.comment)}</td>
                <td class="stat-num">${fmt(data.save)}</td>
                <td class="stat-num">${fmt(data.share)}</td>
                <td class="col-link"><a href="${data.link}" target="_blank">Xem</a></td>
                <td class="col-status status-ok">OK</td>
            `;
        }
    }

    // === CH·ª®C NƒÇNG PH·ª§ ===
    $('clearBtn').addEventListener('click', () => {
        $('linkInput').value = '';
        $('tableBody').innerHTML = '';
        processedData = [];
        updateDashboard(); // Reset dashboard
        $('exportBtn').disabled = true;
        log("ƒê√£ xo√° d·ªØ li·ªáu.");
    });

    // N√∫t D√°n M·∫´u (ƒê√£ c·∫≠p nh·∫≠t link theo y√™u c·∫ßu)
    $('sampleBtn').addEventListener('click', () => {
        const sampleLinks = [
            "https://www.tiktok.com/@letuankhang2002/video/7578120269450071304",
            "https://www.tiktok.com/@letuankhang2002/video/7572146167778397447",
            "https://vt.tiktok.com/ZSfGHPdRK/"
        ];
        $('linkInput').value = sampleLinks.join('\n');
    });

    // Xu·∫•t Excel
    $('exportBtn').addEventListener('click', () => {
        if (!processedData.length) return;
        const headers = ['STT', 'Kenh', 'Caption', 'View', 'Like', 'Comment', 'Save', 'Share', 'Link Goc', 'Trang Thai'];
        const rows = processedData.map(item => {
            if (item.status === 'ERROR') return [item.id, '', 'ERROR', 0, 0, 0, 0, 0, item.link, 'ERROR'];
            const safeCaption = `"${(item.caption || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`;
            return [
                item.id, item.author, safeCaption, 
                item.view, item.like, item.comment, item.save, item.share, 
                item.link, 'OK'
            ];
        });
        const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `TikTok_Stats_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
  </script>
</body>
</html>
